---
- name: Test hosts aliases role
  hosts: localhost
  gather_facts: false
  vars:
    # Use actual hosts from inventory
    dev_hostnames: "{{ groups['all'] | difference(['localhost']) }}"
    dev_ips: []
    dev_alias: []
    dev_vspaths: []
    dev_ansible_ssh_users: []

    # Management host information (using /tmp for testing)
    user: "{{ ansible_user_id }}"
    host: "localhost"
    home: "/tmp/"
    bash: "test_bashrc"
    bash_hosts_aliases: "test_bash_hosts_aliases"
    create_editor_aliases: true
    editor_path: "code"
    comment: "Hosts aliases generated by Ansible"

  pre_tasks:
    # Create the bash profile file for testing
    - name: Ensure test bash profile exists
      ansible.builtin.file:
        path: "/tmp/test_bashrc"
        state: touch
        mode: '0644'

    # Extract IPs from inventory
    - name: Set IPs from inventory
      ansible.builtin.set_fact:
        dev_ips: "{{ dev_ips + [hostvars[item].ansible_host | default('127.0.0.1')] }}"
      loop: "{{ dev_hostnames }}"

    - name: Set aliases from inventory
      ansible.builtin.set_fact:
        dev_alias: "{{ dev_alias + [hostvars[item].alias | default(item)] }}"
      loop: "{{ dev_hostnames }}"

    - name: Set vspaths from inventory
      ansible.builtin.set_fact:
        dev_vspaths: "{{ dev_vspaths + [hostvars[item].vspath | default('/home/' + hostvars[item].ansible_user + '/')] }}"
      loop: "{{ dev_hostnames }}"

    - name: Set SSH users from inventory
      ansible.builtin.set_fact:
        dev_ansible_ssh_users: "{{ dev_ansible_ssh_users + [hostvars[item].ansible_user | default('ansible')] }}"
      loop: "{{ dev_hostnames }}"

  tasks:
    - name: Include test tasks
      ansible.builtin.include_tasks: test_tasks.yml

  post_tasks:
    - name: Verify the aliases file exists
      ansible.builtin.stat:
        path: "/tmp/test_bash_hosts_aliases"
      register: aliases_file

    - name: Check if aliases file exists
      ansible.builtin.assert:
        that: aliases_file.stat.exists
        fail_msg: "The aliases file was not created"
        success_msg: "The aliases file was created successfully"

    - name: Display content of the aliases file
      ansible.builtin.command: cat /tmp/test_bash_hosts_aliases
      register: aliases_content
      changed_when: false

    - name: Show aliases content
      ansible.builtin.debug:
        var: aliases_content.stdout_lines
