---
- name: Test hosts aliases role
  hosts: localhost
  gather_facts: true
  vars:
    # Management host information (using /tmp for testing)
    user: "{{ ansible_user_id }}"
    host: "localhost"
    home: "/tmp/"
    bash: "test_bashrc"
    bash_hosts_aliases: "test_bash_hosts_aliases"
    create_editor_aliases: true
    editor_path: "code"
    comment: "Hosts aliases generated by Ansible"

  pre_tasks:
    # Create the bash profile file for testing
    - name: Ensure test bash profile exists
      ansible.builtin.file:
        path: "/tmp/test_bashrc"
        state: touch
        mode: '0644'

    # Display discovered host information for testing
    - name: Display discovered host information
      ansible.builtin.debug:
        msg:
          - "Host: {{ item }}"
          - "  IP           : {{ hostvars[item].ansible_host | default('') }}"
          - "  Ansible User : {{ hostvars[item].ansible_user | default('') }}"
          - "  Alias        : {{ hostvars[item].alias | default('') }}"
          - "  VS Path      : {{ hostvars[item].vspath | default('') }}"
      loop: "{{ groups['all'] | difference(['localhost']) }}"
      run_once: true

  tasks:
    - name: Include test tasks
      ansible.builtin.include_tasks: test_tasks.yml

  post_tasks:
    - name: Verify the aliases file exists
      ansible.builtin.stat:
        path: "/tmp/test_bash_hosts_aliases"
      register: aliases_file

    - name: Check if aliases file exists
      ansible.builtin.assert:
        that: aliases_file.stat.exists
        fail_msg: "The aliases file was not created"
        success_msg: "The aliases file was created successfully"

    - name: Display content of the aliases file
      ansible.builtin.command: cat /tmp/test_bash_hosts_aliases
      register: aliases_content
      changed_when: false

    - name: Show aliases content
      ansible.builtin.debug:
        var: aliases_content.stdout_lines
